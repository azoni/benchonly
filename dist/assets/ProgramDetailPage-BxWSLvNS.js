import{a as Ke,b as Ue,u as _e,d as Je,r as T,at as V,a3 as be,an as L,al as we,a8 as De,j as e,z as X,A as ze,K as Be,m as Ne,C as G,k as qe,F as Ve,o as Xe,ar as je,i as Qe,S as Ze,au as et,ai as ke,V as tt,W as st,Y as at,$ as rt,a0 as nt,w as ot,x as it}from"./index-Lqbj01pB.js";import{a as ve}from"./index-Ds8TtcrI.js";import{d as $e}from"./index-BPxqPur_.js";import{C as lt}from"./clock-DLdGjHl-.js";import{S as ct}from"./skip-forward-BKXAD8IY.js";import{i as dt}from"./index-o74L4mYE.js";const F={primary:{bg:"bg-flame-500/20",text:"text-flame-400",border:"border-flame-500/30",dot:"bg-flame-500"},volume:{bg:"bg-blue-500/20",text:"text-blue-400",border:"border-blue-500/30",dot:"bg-blue-500"},speed:{bg:"bg-cyan-500/20",text:"text-cyan-400",border:"border-cyan-500/30",dot:"bg-cyan-500"},accessories:{bg:"bg-purple-500/20",text:"text-purple-400",border:"border-purple-500/30",dot:"bg-purple-500"},deload:{bg:"bg-green-500/20",text:"text-green-400",border:"border-green-500/30",dot:"bg-green-500"},test:{bg:"bg-yellow-500/20",text:"text-yellow-400",border:"border-yellow-500/30",dot:"bg-yellow-500"}},mt={sunday:0,monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6};function bt(){var ie,le,ce,de,me,ue,xe;const{id:C}=Ke(),Y=Ue();_e("Program");const{user:v,userProfile:H,updateProfile:Q,isAppAdmin:Se}=Je(),[s,Z]=T.useState(null),[We,Oe]=T.useState(!0),[Pe,ee]=T.useState(new Set),[Te,te]=T.useState(null),[Ce,se]=T.useState(null);T.useEffect(()=>{v&&C&&Ee()},[v,C]);const Ee=async()=>{var t,a,o;try{const r=await V.get(C);if(!r||r.userId!==v.uid){Y("/programs");return}Z(r);const f=(t=r.startDate)!=null&&t.toDate?r.startDate.toDate():r.startDate?new Date(r.startDate):new Date,D=(a=r.endDate)!=null&&a.toDate?r.endDate.toDate():r.endDate?new Date(r.endDate):new Date;let g=[];try{g=await be.getByDateRange(v.uid,f,D)}catch(i){console.error("Error loading program workouts:",i)}const h=g.filter(i=>i.programId===C),N=new Set;h.forEach(i=>{if(i.status==="completed"){const c=L(i.date);N.add(c)}}),ee(N);const y=[];(r.weeks||[]).forEach(i=>{(i.days||[]).forEach(c=>{const d=(()=>{var k,$;if(!r.startDate||!c.dayOfWeek)return null;const l=(k=r.startDate)!=null&&k.toDate?r.startDate.toDate():new Date(r.startDate);if(isNaN(l.getTime()))return null;const j={monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6,sunday:0}[($=c.dayOfWeek)==null?void 0:$.toLowerCase()];if(j===void 0)return null;const O=ve(we(l,{weekStartsOn:1}),i.weekNumber-1),p=j>=1?j-1:j+6;return De(O,p)})();d&&N.has(L(d))&&y.push(`${i.weekNumber}-${c.dayOfWeek}`)})}),JSON.stringify(y.sort())!==JSON.stringify((r.completedDays||[]).sort())&&(V.update(C,{completedDays:y}).catch(i=>console.error("[ProgramDetail] Sync failed:",i.message)),r.completedDays=y);const n=$e(new Date,f),b=Math.floor(n/7);b>=0&&b<(((o=r.weeks)==null?void 0:o.length)||0)&&te(b)}catch(r){console.error("Error loading program:",r)}finally{Oe(!1)}},E=(t,a)=>{var h;if(!(s!=null&&s.startDate)||!a)return null;const o=(h=s.startDate)!=null&&h.toDate?s.startDate.toDate():new Date(s.startDate);if(isNaN(o.getTime()))return null;const r=mt[a.toLowerCase()];if(r===void 0)return null;const f=ve(we(o,{weekStartsOn:1}),t-1),D=1,g=r>=D?r-D:r+7-D;return De(f,g)},A=(t,a)=>{const o=E(t,a);return o?Pe.has(L(o)):!1},ae=(t,a)=>{const o=E(t,a);return o?dt(et(o))&&!ke(o):!1},re=(t,a)=>{const o=E(t,a);return o?ke(o):!1},Ae=async(t,a)=>{var g,h,N,y,W,n,b,i,c;const o=Se,r=(H==null?void 0:H.credits)??0,f=je["generate-workout"];if(!o&&r<f){alert(`Not enough credits. Need ${f}, have ${r}.`);return}const D=`${t}-${a.dayOfWeek}`;se(D);try{o||Q({credits:r-f});const d={},l={},j=new Date,O=await tt(st(at(rt,"workouts"),nt("userId","==",v.uid)));O.docs.forEach(m=>{var ye;const P=m.data();if(P.status!=="completed")return;const he=(ye=P.date)!=null&&ye.toDate?P.date.toDate():P.date?new Date(P.date):null,R=he?Math.floor((j-he)/(1e3*60*60*24)):null;(P.exercises||[]).forEach(u=>{(u.sets||[]).forEach(w=>{if(!w.actualWeight&&!w.actualReps&&w.prescribedWeight)return;const B=parseFloat(w.actualWeight||w.prescribedWeight||0),q=parseInt(w.actualReps||w.prescribedReps||0);if(B>0&&q>0){const I=Math.round(B*(1+q/30));(!d[u.name]||I>d[u.name].e1rm)&&(d[u.name]={e1rm:I,weight:B,reps:q})}if(w.painLevel&&parseInt(w.painLevel)>0){const I=parseInt(w.painLevel);l[u.name]||(l[u.name]={count:0,maxPain:0,lastDaysAgo:null,recentCount:0}),l[u.name].count++,l[u.name].maxPain=Math.max(l[u.name].maxPain,I),R!==null&&((l[u.name].lastDaysAgo===null||R<l[u.name].lastDaysAgo)&&(l[u.name].lastDaysAgo=R),R<=30&&l[u.name].recentCount++)}})})});const p=a.primaryLift||((h=(g=s.goal)==null?void 0:g.lifts)==null?void 0:h[0])||((N=s.goal)==null?void 0:N.lift)||"Bench Press",k=((y=d[p])==null?void 0:y.e1rm)||((W=s.goal)!=null&&W.current?parseFloat(s.goal.current):0),$=((n=s.goal)==null?void 0:n.lifts)||((b=s.goal)!=null&&b.lift?[s.goal.lift]:[]),J=(((c=(i=s.weeks)==null?void 0:i.find(m=>m.weekNumber===t))==null?void 0:c.days)||[]).map(m=>`${m.dayOfWeek}: ${m.label} (${m.primaryLift} ${m.primaryScheme})`).join(", "),z=`Generate a workout based on this program day:

PROGRAM: ${s.name}
PROGRAM TYPE: ${s.programType||"strength"}
WEEK ${t} of ${s.numWeeks||"?"} — ${a.phase||""} Phase
ALL PROGRAM LIFTS: ${$.join(", ")||p}
THIS WEEK'S SCHEDULE: ${J}

TODAY'S PRESCRIPTION:
- Day Type: ${a.type}
- Label: ${a.label}
- Primary Lift: ${p}
- Scheme: ${a.primaryScheme} @ ${a.intensity}${k?` (athlete's ${p} e1RM: ${k}lb)`:""}
- Prescribed Accessories: ${(a.accessories||[]).join(", ")}
- Coach Notes: ${a.notes||"none"}
${s.workoutDuration?`- Target Duration: ~${s.workoutDuration} minutes`:""}

INSTRUCTIONS:
- The PRIMARY exercise MUST be ${p}. This is the main lift for today.
- Calculate actual working weights from the athlete's e1RM data.
- Accessories should directly support ${p} — same muscle groups and movement patterns.
- Follow the prescribed scheme (${a.primaryScheme}) and intensity (${a.intensity}).
${a.type==="deload"?"- This is a DELOAD day. Reduce volume 40-50%, keep weights light.":""}
${a.type==="test"?"- This is a TEST day. Work up to a heavy single or rep max.":""}`,Le=await ot(),pe=await fetch(it("generate-workout"),{method:"POST",headers:Le,body:JSON.stringify({targetUserId:v.uid,prompt:z,workoutFocus:a.type==="test"?"Testing":a.type==="deload"?"Recovery":`${p} focused`,intensity:a.type==="deload"?"recovery":a.type==="volume"?"moderate":"heavy",context:{maxLifts:d,painHistory:l,recentWorkouts:O.docs.slice(0,5).map(m=>m.data())},model:"standard",settings:{},draftMode:!1})});if(!pe.ok)throw new Error("Failed to generate workout");const Ge=await pe.json(),fe=E(t,a.dayOfWeek)||new Date,Fe={...Ge.workout,date:fe.toISOString(),programId:s.id,programWeek:t,programDayType:a.type,status:"scheduled"},Ye=await be.create(v.uid,Fe),He=L(fe);ee(m=>new Set([...m,He]));const ge=[...s.completedDays||[],`${t}-${a.dayOfWeek}`];await V.update(s.id,{completedDays:ge}),Z(m=>({...m,completedDays:ge})),Y(`/workouts/${Ye.id}`)}catch(d){console.error("Generate error:",d),o||Q({credits:r}),alert("Failed to generate workout.")}finally{se(null)}};if(We)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 border-2 border-flame-500 border-t-transparent rounded-full animate-spin"})});if(!s)return null;const x=s.goal||{},M=(ie=s.startDate)!=null&&ie.toDate?s.startDate.toDate():s.startDate?new Date(s.startDate):null,K=(le=s.endDate)!=null&&le.toDate?s.endDate.toDate():s.endDate?new Date(s.endDate):null,Me=M&&!isNaN(M.getTime())?X(M,"MMM d"):"—",Re=K&&!isNaN(K.getTime())?X(K,"MMM d"):"—",Ie=$e(new Date,M),S=Math.floor(Ie/7)+1,U=(s.weeks||[]).reduce((t,a)=>{var o;return t+(((o=a.days)==null?void 0:o.length)||0)},0),ne=(s.completedDays||[]).length,oe=U>0?Math.round(ne/U*100):0;return e.jsxs("div",{className:"max-w-2xl mx-auto p-4 pb-32",children:[e.jsxs("button",{onClick:()=>Y("/programs"),className:"flex items-center gap-2 text-iron-400 hover:text-iron-200 mb-4",children:[e.jsx(ze,{className:"w-4 h-4"})," Programs"]}),e.jsxs("div",{className:"card-steel p-5 rounded-xl mb-6",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[e.jsx("div",{className:`w-12 h-12 rounded-xl flex items-center justify-center ${s.status==="active"?"bg-flame-500/20":"bg-iron-800"}`,children:e.jsx(Be,{className:`w-6 h-6 ${s.status==="active"?"text-flame-400":"text-iron-500"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-xl font-display text-iron-100",children:s.name}),s.status==="paused"&&e.jsx("span",{className:"px-2 py-0.5 text-xs rounded bg-yellow-500/20 text-yellow-400",children:"Paused"})]}),e.jsxs("p",{className:"text-sm text-iron-500",children:[((ce=x.lifts)==null?void 0:ce.length)>0?x.lifts.join(", "):x.lift||x.type||"Program",x.current&&x.target?`: ${x.current} → ${x.target}${x.type==="bodyweight"?"":"lb"}`:x.current?` (${x.current}${x.type==="bodyweight"?"":"lb"})`:""," · ",Me," – ",Re]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"flex-1 h-2 bg-iron-800 rounded-full overflow-hidden",children:e.jsx(Ne.div,{className:"h-full bg-flame-500 rounded-full",initial:{width:0},animate:{width:`${oe}%`},transition:{duration:.6}})}),e.jsxs("span",{className:"text-sm text-iron-400 font-medium",children:[oe,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-iron-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(G,{className:"w-3 h-3 text-green-400"})," ",ne,"/",U," sessions"]}),S>0&&S<=(((de=s.weeks)==null?void 0:de.length)||0)&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(qe,{className:"w-3 h-3 text-flame-400"})," Week ",S]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(lt,{className:"w-3 h-3"})," ",(me=s.trainingDays)==null?void 0:me.length,"x/week"]})]})]}),((ue=s.phases)==null?void 0:ue.length)>0&&e.jsx("div",{className:"flex gap-2 mb-4 overflow-x-auto pb-1",children:s.phases.map((t,a)=>{const o=S>=t.weekStart&&S<=t.weekEnd;return e.jsxs("div",{className:`flex-shrink-0 px-3 py-2 rounded-lg text-xs border ${o?"bg-flame-500/10 border-flame-500/30 text-flame-400":"bg-iron-800/50 border-iron-800 text-iron-400"}`,children:[e.jsx("span",{className:"font-medium",children:t.name}),e.jsxs("span",{className:"ml-1.5 opacity-70",children:["Wk ",t.weekStart,"–",t.weekEnd]})]},a)})}),e.jsx("div",{className:"space-y-2",children:(xe=s.weeks)==null?void 0:xe.map((t,a)=>{var g,h,N,y,W;const o=t.weekNumber===S,r=Te===a,f=(g=t.days)==null?void 0:g.every(n=>A(t.weekNumber,n.dayOfWeek)),D=((h=t.days)==null?void 0:h.filter(n=>A(t.weekNumber,n.dayOfWeek)).length)||0;return e.jsxs("div",{className:`card-steel rounded-xl overflow-hidden ${o?"ring-1 ring-flame-500/30":""}`,children:[e.jsxs("button",{onClick:()=>te(r?null:a),className:"w-full px-4 py-3 flex items-center gap-3 hover:bg-iron-800/30 transition-colors",children:[e.jsx("div",{className:`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold ${f?"bg-green-500/20 text-green-400":o?"bg-flame-500/20 text-flame-400":"bg-iron-800 text-iron-400"}`,children:f?e.jsx(G,{className:"w-4 h-4"}):t.weekNumber}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium text-iron-200",children:["Week ",t.weekNumber]}),e.jsx("span",{className:"text-xs text-iron-500",children:t.phase}),o&&e.jsx("span",{className:"px-1.5 py-0.5 text-[10px] rounded bg-flame-500/20 text-flame-400",children:"Current"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[(N=t.days)==null?void 0:N.map((n,b)=>{const i=F[n.type]||F.primary,c=A(t.weekNumber,n.dayOfWeek),d=ae(t.weekNumber,n.dayOfWeek),l=re(t.weekNumber,n.dayOfWeek);return e.jsx("div",{className:`w-2 h-2 rounded-full ${c?"bg-green-500":l?`${i.dot} animate-pulse`:d?"bg-iron-600":i.dot+"/40"}`},b)}),e.jsxs("span",{className:"text-xs text-iron-600 ml-1",children:[D,"/",((y=t.days)==null?void 0:y.length)||0]})]})]}),e.jsx(Ve,{className:`w-4 h-4 text-iron-600 transition-transform ${r?"rotate-90":""}`})]}),e.jsx(Xe,{children:r&&e.jsx(Ne.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"px-4 pb-3 space-y-2 border-t border-iron-800 pt-3",children:(W=t.days)==null?void 0:W.map((n,b)=>{var k,$,_;const i=F[n.type]||F.primary,c=A(t.weekNumber,n.dayOfWeek),d=ae(t.weekNumber,n.dayOfWeek),l=re(t.weekNumber,n.dayOfWeek),j=E(t.weekNumber,n.dayOfWeek),O=`${t.weekNumber}-${n.dayOfWeek}`,p=Ce===O;return e.jsx("div",{className:`p-3 rounded-lg border transition-colors ${c?"bg-green-500/5 border-green-500/20":l?`${i.bg} ${i.border} border`:"bg-iron-800/20 border-iron-800/50"}`,children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:`text-sm font-medium capitalize ${c?"text-green-400":"text-iron-200"}`,children:[(k=n.dayOfWeek)==null?void 0:k.slice(0,3),j&&e.jsx("span",{className:"text-iron-500 font-normal ml-1",children:X(j,"MMM d")})]}),e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${i.bg} ${i.text}`,children:n.type}),c&&e.jsx(G,{className:"w-3.5 h-3.5 text-green-400"}),l&&!c&&e.jsx("span",{className:"text-[10px] text-flame-400 font-medium",children:"TODAY"})]}),e.jsx("p",{className:"text-sm text-iron-300 mt-0.5",children:n.label}),e.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[e.jsxs("span",{className:"text-xs text-flame-400 font-medium",children:[n.primaryScheme," @ ",n.intensity]}),(($=n.accessories)==null?void 0:$.length)>0&&e.jsxs("span",{className:"text-xs text-iron-500",children:["+ ",n.accessories.length," accessories"]})]}),n.notes&&e.jsx("p",{className:"text-xs text-iron-500 mt-1 italic",children:n.notes}),((_=n.accessories)==null?void 0:_.length)>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1.5",children:n.accessories.map((J,z)=>e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 bg-iron-800/50 rounded text-iron-400",children:J},z))})]}),e.jsx("div",{className:"flex-shrink-0",children:c?e.jsx("div",{className:"w-9 h-9 rounded-lg bg-green-500/20 flex items-center justify-center",children:e.jsx(G,{className:"w-4 h-4 text-green-400"})}):d&&!c?e.jsx("div",{className:"w-9 h-9 rounded-lg bg-iron-800 flex items-center justify-center",title:"Missed",children:e.jsx(ct,{className:"w-4 h-4 text-iron-600"})}):e.jsxs("button",{onClick:()=>Ae(t.weekNumber,n),disabled:p||s.status!=="active",className:`px-3 py-2 rounded-lg text-xs font-medium flex items-center gap-1.5 transition-colors ${l?"bg-flame-500 text-white hover:bg-flame-400":"bg-iron-800 text-iron-300 hover:bg-iron-700"} disabled:opacity-40`,title:`Generate workout (${je["generate-workout"]} credits)`,children:[p?e.jsx(Qe,{className:"w-3.5 h-3.5 animate-spin"}):e.jsx(Ze,{className:"w-3.5 h-3.5"}),l?"Start":"Generate"]})})]})},b)})})})})]},a)})})]})}export{bt as default};

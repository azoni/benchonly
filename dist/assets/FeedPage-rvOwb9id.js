import{u as Se,d as Ce,b as Ie,r as l,aa as Fe,V as De,Y as Ae,$ as Le,h as Re,f as $e,ab as C,j as s,t as I,L as E,U as T,ac as U,i as M,ad as We,I as ae,n as re,F as _e,ae as Ge,X as Ee,s as Te,a3 as Ue,af as Me,M as Pe,K as Be}from"./index-Bu1DCD4H.js";import{S as Ve}from"./search-DpIMhD4D.js";import{G as He}from"./globe-IU6iLf89.js";import{f as oe}from"./index-C9IuBzhn.js";import{C as Ke}from"./clock-ySZ75key.js";import{C as Oe}from"./copy-CLp89WKL.js";import{T as Qe}from"./trash-2-b18YEtdV.js";import{T as qe}from"./trophy-r8dcLTK3.js";import"./index-_CznCMm7.js";function ls(){Se("Feed");const{user:a,isGuest:h,isAppAdmin:A,isRealAdmin:ze,impersonating:Xe,realUser:Ye}=Ce(),ne=Ie(),[le,f]=l.useState([]),[p,ie]=l.useState({}),[ce,F]=l.useState(!0),[P,B]=l.useState(!1),[de,V]=l.useState(null),[xe,H]=l.useState(!0),[L,ue]=l.useState(""),[g,R]=l.useState(null),[K,O]=l.useState([]),[j,Q]=l.useState(""),[q,z]=l.useState(!1),[X,me]=l.useState(new Set),[pe,he]=l.useState(new Set),[$,ge]=l.useState("all"),[y,fe]=l.useState("all"),[W,je]=l.useState(new Set),[_,Y]=l.useState(null),ye=async e=>{var t,r,o;if(!(!a||h||_)){Y(e.id);try{const n=((t=e.data)==null?void 0:t.exerciseSummary)||[];if(!n.length){alert("No exercise data to copy");return}const i=n.map(d=>({name:d.name,type:d.topWeight?"weight":"bodyweight",sets:Array.from({length:d.sets||3},()=>({prescribedWeight:d.topWeight?String(d.topWeight):"",prescribedReps:d.topReps?String(d.topReps):"",actualWeight:"",actualReps:"",rpe:"",painLevel:0})),restSeconds:90,notes:""})),u=((r=p[e.userId])==null?void 0:r.displayName)||"someone",m=await Ue.create(a.uid,{name:`${((o=e.data)==null?void 0:o.name)||"Workout"} (from ${u})`,exercises:i,date:new Date,workoutType:"strength"});ne(`/workouts/${m.id}`)}catch(n){console.error("Copy failed:",n),alert("Failed to copy workout")}finally{Y(null)}}},Ne=e=>{if(!a)return e.visibility==="public"||!e.visibility;if(e.userId===a.uid||A)return!0;switch(e.visibility||"public"){case"public":return!0;case"friends":return X.has(e.userId);case"group":return e.groupId&&pe.has(e.groupId);case"private":return!1;default:return!0}};l.useEffect(()=>{be()},[a==null?void 0:a.uid]);const be=async()=>{F(!0);try{a&&!h&&Fe.markAllAsRead(a.uid).catch(()=>{});const[e,t,r]=await Promise.all([De(Ae(Le,"users")),a&&!h?Re.getFriendSet(a.uid):Promise.resolve(new Set),a&&!h?$e.getByUser(a.uid):Promise.resolve([])]),o={};e.docs.forEach(i=>{o[i.id]={id:i.id,...i.data()}}),ie(o),me(t),he(new Set(r.map(i=>i.id)));const n=await C.getFeed(30);f(n.items),V(n.lastDoc),H(n.hasMore)}catch(e){console.error("Error loading feed:",e)}finally{F(!1)}},we=async(e=!1)=>{e?B(!0):F(!0);try{const t=await C.getFeed(30,e?de:null);f(e?r=>[...r,...t.items]:t.items),V(t.lastDoc),H(t.hasMore&&t.items.length>0)}catch(t){console.error("Error loading feed:",t)}finally{F(!1),B(!1)}},ve=async e=>{R(e);const t=await C.getComments(e.id);O(t)},J=async()=>{if(!(!j.trim()||!g||h)){z(!0);try{const e=await C.addComment(g.id,a.uid,j.trim(),a.displayName||"");e&&(O(t=>[...t,{id:e.id,userId:a.uid,text:j.trim(),createdAt:{toDate:()=>new Date}}]),Q(""),f(t=>t.map(r=>r.id===g.id?{...r,commentCount:(r.commentCount||0)+1}:r)))}catch(e){console.error("Error adding comment:",e)}finally{z(!1)}}},ke=async e=>{if(confirm("Delete this post from the feed?"))try{await C.deleteFeedItem(e,a.uid,A),f(t=>t.filter(r=>r.id!==e))}catch(t){console.error("Error deleting feed item:",t)}},Z=(e,t)=>{var o,n;if((o=t==null?void 0:t.data)!=null&&o.eventId)return s.jsx(Me,{className:"w-5 h-5 text-pink-400 fill-pink-400"});if(e==="group_workout"||(t==null?void 0:t.groupId)||((n=t==null?void 0:t.data)==null?void 0:n.groupId))return s.jsx(T,{className:"w-5 h-5 text-cyan-400"});switch(e){case"workout":return s.jsx(ae,{className:"w-5 h-5 text-green-400"});case"cardio":return s.jsx(I,{className:"w-5 h-5 text-orange-400"});case"goal_completed":return s.jsx(qe,{className:"w-5 h-5 text-yellow-400"});case"goal_created":return s.jsx(Be,{className:"w-5 h-5 text-purple-400"});case"personal_record":return s.jsx(Pe,{className:"w-5 h-5 text-flame-400"});default:return s.jsx(I,{className:"w-5 h-5 text-iron-400"})}},ee=e=>{var o,n,i,u,m,d,N,b,c,x,w,v,k,S;const t=((o=p[e.userId])==null?void 0:o.displayName)||"Someone";if(e.type==="group_workout"||e.groupId||((n=e.data)==null?void 0:n.groupId))return s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:t})," completed their workout in ",s.jsx("span",{className:"text-cyan-400",children:((i=e.data)==null?void 0:i.groupName)||"a group"})]});switch(e.type){case"workout":return s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:t})," completed ",s.jsx("span",{className:"text-flame-400",children:((u=e.data)==null?void 0:u.name)||"a workout"})]});case"cardio":return s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:t})," logged ",s.jsxs("span",{className:"text-orange-400",children:[(m=e.data)==null?void 0:m.duration,"min of ",((d=e.data)==null?void 0:d.name)||"cardio"]})]});case"goal_completed":return s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:t})," achieved their goal: ",s.jsxs("span",{className:"text-yellow-400",children:[(N=e.data)==null?void 0:N.lift," - ",(b=e.data)==null?void 0:b.targetValue," ",(c=e.data)==null?void 0:c.unit]})]});case"goal_created":return s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:t})," set a new goal: ",s.jsxs("span",{className:"text-purple-400",children:[(x=e.data)==null?void 0:x.lift," - ",(w=e.data)==null?void 0:w.targetValue," ",(v=e.data)==null?void 0:v.unit]})]});case"personal_record":return s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:t})," hit a new PR: ",s.jsxs("span",{className:"text-flame-400",children:[(k=e.data)==null?void 0:k.exercise," - ",(S=e.data)==null?void 0:S.weight,"lbs"]})]});default:return s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:t})," was active"]})}},G=le.filter(Ne),D=$==="all"?G:$==="friends"?G.filter(e=>X.has(e.userId)||e.userId===(a==null?void 0:a.uid)):G.filter(e=>e.userId===(a==null?void 0:a.uid)),se=y==="all"?D:y==="workout"?D.filter(e=>{var t;return e.type==="workout"||e.type==="group_workout"||e.groupId||((t=e.data)==null?void 0:t.groupId)}):y==="goal_completed"?D.filter(e=>e.type==="goal_completed"||e.type==="goal_created"):D.filter(e=>e.type===y),te=L?se.filter(e=>{var n,i,u,m;const t=((i=(n=p[e.userId])==null?void 0:n.displayName)==null?void 0:i.toLowerCase())||"",r=((m=(u=e.data)==null?void 0:u.name)==null?void 0:m.toLowerCase())||"",o=L.toLowerCase();return t.includes(o)||r.includes(o)}):se;return h?s.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-12 text-center",children:[s.jsx(I,{className:"w-16 h-16 text-iron-600 mx-auto mb-4"}),s.jsx("h2",{className:"text-xl font-display text-iron-200 mb-2",children:"Community Feed"}),s.jsx("p",{className:"text-iron-500 mb-6",children:"Sign in to see what others are up to and share your progress!"}),s.jsx(E,{to:"/login",className:"btn-primary",children:"Sign In"})]}):s.jsxs("div",{className:"max-w-2xl mx-auto pb-24",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("div",{children:[s.jsxs("h1",{className:"text-2xl font-display text-iron-100 flex items-center gap-3",children:[s.jsx(I,{className:"w-7 h-7 text-flame-500"}),"Community Feed"]}),s.jsx("p",{className:"text-iron-500 text-sm mt-1",children:"See what the community is up to"})]}),Object.keys(p).length>0&&s.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-iron-800/50 rounded-full border border-iron-700/50",children:[s.jsx(T,{className:"w-4 h-4 text-flame-400"}),s.jsx("span",{className:"text-sm font-medium text-iron-300",children:Object.keys(p).length}),s.jsx("span",{className:"text-xs text-iron-500",children:"Active"})]})]}),s.jsx("div",{className:"card-steel p-4 mb-4",children:s.jsxs("div",{className:"relative",children:[s.jsx(Ve,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-iron-500"}),s.jsx("input",{type:"text",placeholder:"Search by name or activity...",value:L,onChange:e=>ue(e.target.value),className:"input-field w-full pl-10"})]})}),s.jsx("div",{className:"flex items-center gap-2 mb-3",children:[{key:"all",label:"All",icon:He},{key:"friends",label:"Friends",icon:T},{key:"mine",label:"Mine",icon:U}].map(e=>s.jsxs("button",{onClick:()=>ge(e.key),className:`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${$===e.key?"bg-flame-500/20 text-flame-400 border border-flame-500/30":"bg-iron-800/50 text-iron-400 border border-iron-700/50 hover:text-iron-200"}`,children:[s.jsx(e.icon,{className:"w-3.5 h-3.5"}),e.label]},e.key))}),s.jsx("div",{className:"flex items-center gap-1.5 mb-6 overflow-x-auto pb-1",children:[{key:"all",label:"All"},{key:"workout",label:"Workouts"},{key:"cardio",label:"Cardio"},{key:"personal_record",label:"PRs"},{key:"goal_completed",label:"Goals"}].map(e=>s.jsx("button",{onClick:()=>fe(e.key),className:`px-2.5 py-1 rounded-lg text-xs font-medium transition-colors whitespace-nowrap ${y===e.key?"bg-iron-700 text-iron-100":"text-iron-500 hover:text-iron-300"}`,children:e.label},e.key))}),ce?s.jsxs("div",{className:"card-steel p-12 text-center",children:[s.jsx(M,{className:"w-8 h-8 text-flame-500 animate-spin mx-auto"}),s.jsx("p",{className:"text-iron-500 mt-4",children:"Loading feed..."})]}):te.length===0?s.jsxs("div",{className:"card-steel p-12 text-center",children:[s.jsx(I,{className:"w-12 h-12 text-iron-600 mx-auto mb-4"}),s.jsx("p",{className:"text-iron-500",children:"No activity yet. Be the first to log a workout!"})]}):s.jsxs("div",{className:"space-y-4",children:[te.map(e=>{var n,i,u,m,d,N,b;const t=p[e.userId],r=`/profile/${(t==null?void 0:t.username)||e.userId}`,o=e.type==="group_workout"||!!e.groupId||!!((n=e.data)!=null&&n.groupId);return s.jsxs("div",{className:"card-steel p-4",children:[s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx(E,{to:r,state:{from:"/feed",fromLabel:"Back to Feed"},className:"w-10 h-10 rounded-full bg-iron-800 flex items-center justify-center text-iron-400 hover:bg-iron-700 transition-colors",children:t!=null&&t.photoURL?s.jsx("img",{src:t.photoURL,alt:"",className:"w-10 h-10 rounded-full"}):s.jsx(U,{className:"w-5 h-5"})}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[Z(e.type,e),s.jsx("p",{className:"text-sm text-iron-200",children:ee(e)})]}),s.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[s.jsx("p",{className:"text-xs text-iron-600",children:((i=e.createdAt)==null?void 0:i.toDate)&&oe(e.createdAt.toDate(),{addSuffix:!0})}),e.visibility&&e.visibility!=="public"&&s.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded-full ${e.visibility==="friends"?"bg-blue-500/10 text-blue-400":e.visibility==="group"?"bg-green-500/10 text-green-400":"bg-iron-700 text-iron-500"}`,children:e.visibility==="friends"?"Friends":e.visibility==="group"?"Group":"Private"})]})]})]}),(e.type==="workout"||o)&&(()=>{var x,w,v,k,S;const c=We((x=e.data)==null?void 0:x.totalSets,(w=e.data)==null?void 0:w.duration);return c?s.jsxs("div",{className:"mt-2 ml-[52px] flex items-center gap-1.5 text-xs text-iron-500",children:[s.jsx(Ke,{className:"w-3 h-3"}),c,(v=e.data)!=null&&v.exerciseCount?` · ${e.data.exerciseCount} exercises`:"",(k=e.data)!=null&&k.totalSets?` · ${e.data.totalSets} sets`:""]}):(S=e.data)!=null&&S.exerciseCount?s.jsxs("div",{className:"mt-2 ml-[52px] flex items-center gap-1.5 text-xs text-iron-500",children:[s.jsx(ae,{className:"w-3 h-3"}),e.data.exerciseCount," exercises"]}):null})(),(e.type==="workout"||o)&&((m=(u=e.data)==null?void 0:u.exerciseSummary)==null?void 0:m.length)>0&&s.jsxs("div",{className:"mt-2 ml-[52px]",children:[s.jsxs("button",{onClick:()=>je(c=>{const x=new Set(c);return x.has(e.id)?x.delete(e.id):x.add(e.id),x}),className:"text-xs text-iron-500 hover:text-iron-300 transition-colors flex items-center gap-1",children:[W.has(e.id)?s.jsx(re,{className:"w-3 h-3"}):s.jsx(_e,{className:"w-3 h-3"}),W.has(e.id)?"Hide exercises":"Show exercises"]}),W.has(e.id)&&s.jsx("div",{className:"mt-2 space-y-1",children:e.data.exerciseSummary.map((c,x)=>s.jsxs("div",{className:"flex items-center justify-between py-1.5 px-3 bg-iron-800/40 rounded-lg",children:[s.jsx("span",{className:"text-xs text-iron-300",children:c.name}),s.jsxs("span",{className:"text-xs text-iron-500",children:[c.sets,"×",c.topWeight?`${c.topReps}@${c.topWeight}lbs`:c.topReps?`${c.topReps} reps`:""]})]},x))})]}),((d=e.data)==null?void 0:d.workoutId)&&e.userId===(a==null?void 0:a.uid)&&s.jsx(E,{to:o?`/workouts/group/${e.data.workoutId}`:`/workouts/${e.data.workoutId}`,className:"mt-2 ml-[52px] block p-2.5 bg-iron-800/50 rounded-lg text-xs text-iron-400 hover:text-iron-200 hover:bg-iron-800 transition-colors",children:"View full workout details →"}),s.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[s.jsxs("button",{onClick:()=>ve(e),className:"px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5 bg-iron-800 text-iron-400 hover:bg-iron-700 transition-colors",children:[s.jsx(Ge,{className:"w-4 h-4"}),e.commentCount>0?`${e.commentCount} comment${e.commentCount!==1?"s":""}`:"Comment"]}),(e.type==="workout"||o)&&((b=(N=e.data)==null?void 0:N.exerciseSummary)==null?void 0:b.length)>0&&e.userId!==(a==null?void 0:a.uid)&&!h&&s.jsxs("button",{onClick:()=>ye(e),disabled:_===e.id,className:"px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5 bg-iron-800 text-iron-400 hover:bg-iron-700 hover:text-flame-400 transition-colors",children:[s.jsx(Oe,{className:"w-4 h-4"}),_===e.id?"Copying...":"Copy Workout"]}),A&&s.jsx("button",{onClick:()=>ke(e.id),className:"ml-auto p-1.5 rounded-lg text-iron-600 hover:text-red-400 hover:bg-red-500/10 transition-colors",title:"Delete post",children:s.jsx(Qe,{className:"w-4 h-4"})})]})]},e.id)}),xe&&s.jsx("button",{onClick:()=>we(!0),disabled:P,className:"w-full py-3 text-center text-iron-400 hover:text-iron-200 transition-colors flex items-center justify-center gap-2",children:P?s.jsxs(s.Fragment,{children:[s.jsx(M,{className:"w-4 h-4 animate-spin"}),"Loading..."]}):s.jsxs(s.Fragment,{children:[s.jsx(re,{className:"w-4 h-4"}),"Load more"]})})]}),g&&s.jsxs("div",{className:"fixed inset-0 z-50 flex items-end sm:items-center justify-center",children:[s.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>R(null)}),s.jsxs("div",{className:"relative bg-iron-900 border border-iron-700 rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg max-h-[80vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-iron-800",children:[s.jsx("h3",{className:"font-display text-lg text-iron-100",children:"Comments"}),s.jsx("button",{onClick:()=>R(null),className:"text-iron-500 hover:text-iron-300",children:s.jsx(Ee,{className:"w-5 h-5"})})]}),s.jsx("div",{className:"p-4 bg-iron-800/50 border-b border-iron-800",children:s.jsxs("div",{className:"flex items-center gap-2 text-sm text-iron-300",children:[Z(g.type,g),ee(g)]})}),s.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:K.length===0?s.jsx("p",{className:"text-center text-iron-500 py-8",children:"No comments yet. Be the first!"}):K.map(e=>{var t,r,o;return s.jsxs("div",{className:"flex gap-3",children:[s.jsx("div",{className:"w-8 h-8 rounded-full bg-iron-800 flex items-center justify-center text-iron-400 flex-shrink-0 overflow-hidden",children:(t=p[e.userId])!=null&&t.photoURL?s.jsx("img",{src:p[e.userId].photoURL,alt:"",className:"w-8 h-8 rounded-full"}):s.jsx(U,{className:"w-4 h-4"})}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"bg-iron-800 rounded-lg p-3",children:[s.jsx("p",{className:"text-xs text-iron-500 mb-1",children:((r=p[e.userId])==null?void 0:r.displayName)||"User"}),s.jsx("p",{className:"text-sm text-iron-200",children:e.text})]}),s.jsx("p",{className:"text-xs text-iron-600 mt-1",children:((o=e.createdAt)==null?void 0:o.toDate)&&oe(e.createdAt.toDate(),{addSuffix:!0})})]})]},e.id)})}),s.jsx("div",{className:"p-4 border-t border-iron-800",children:s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{type:"text",value:j,onChange:e=>Q(e.target.value),onKeyDown:e=>e.key==="Enter"&&J(),placeholder:"Add a comment...",className:"input-field flex-1"}),s.jsx("button",{onClick:J,disabled:!j.trim()||q,className:"btn-primary px-4",children:q?s.jsx(M,{className:"w-4 h-4 animate-spin"}):s.jsx(Te,{className:"w-4 h-4"})})]})})]})]})]})}export{ls as default};
